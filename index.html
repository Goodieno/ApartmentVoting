<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì•„íŒŒíŠ¸ íˆ¬í‘œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  background: linear-gradient(180deg, #f4f6f8, #eef1f5);
  text-align: center;
}

h1 { font-size: 1.7em; margin-bottom: 6px; }
h2 { font-size: 1.3em; }

.panel {
  background: #fff;
  border-radius: 18px;
  padding: 20px 16px;
  max-width: 720px;
  margin: 14px auto;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

button {
  padding: 12px 16px;
  border-radius: 10px;
  border: none;
  background: #e0e0e0;
  font-size: 16px;
  cursor: pointer;
}

.hidden { display: none; }

#classLinks {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 14px;
}

.score-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  max-width: 420px;
  margin: 8px auto 18px auto;
}

.score-buttons button.selected {
  background: #0078d7;
  color: white;
  font-weight: bold;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 14px;
  font-size: 0.9em;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@media (min-width:600px) {
  #classLinks { grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>

<body>

<h1>5í•™ë…„ ì•„íŒŒíŠ¸ íˆ¬í‘œ</h1>
<p style="color:#c62828; font-weight:bold;">
* êµì‚¬ë‹¹ 1íšŒë§Œ íˆ¬í‘œí•´ ì£¼ì„¸ìš” *
</p>

<div id="countdown" style="font-weight:bold; font-size:1.15em; margin:10px 0;"></div>

<!-- HOME -->
<div id="home" class="panel">
  <h2>ë°˜ ëª©ë¡</h2>
  <div id="classLinks"></div>
  <div id="totalCounter" style="margin-top:14px; font-weight:bold;">ì´ íˆ¬í‘œ ìˆ˜: 0</div>
</div>

<!-- RESULTS (PUBLIC) -->
<div id="resultsPage" class="panel hidden">
  <h2>ğŸ† ìµœì¢… ê²°ê³¼</h2>
  <div id="podium"></div>

  <h3 style="margin-top:20px;">ì „ì²´ íˆ¬í‘œ ë‚´ì—­</h3>
  <table>
    <thead>
      <tr>
        <th>ë°˜</th><th>í’ˆì§ˆ</th><th>ë§ì¶¤ë²•</th>
        <th>ì°½ì˜ì„±</th><th>ì˜ì–´</th><th>ì‹œê°„</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyD0tDXxueqQAkEYsNGDHUcQM5TWf2FKyyk",
  databaseURL: "https://apartmentvoting-default-rtdb.firebaseio.com"
});

const db = getDatabase(app);
const VOTING_END = new Date(2026,0,7,15,30);

let hasSwitched = false;

function updateCountdown() {
  const now = new Date();
  const diff = VOTING_END - now;
  const el = document.getElementById("countdown");

  if (diff <= 0) {
    el.textContent = "â›” íˆ¬í‘œ ì¢…ë£Œ";
    el.style.color = "#c62828";
    autoShowResults();
    return;
  }

  const h = Math.floor(diff / 3600000);
  const m = Math.floor(diff % 3600000 / 60000);
  const s = Math.floor(diff % 60000 / 1000);

  el.textContent = `â° íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;

  if (diff <= 600000) {
    el.style.color = "#d32f2f";
    el.style.animation = "pulse 1s infinite";
  }
}

setInterval(updateCountdown, 1000);
updateCountdown();

function autoShowResults() {
  if (hasSwitched) return;
  hasSwitched = true;

  document.getElementById("home").classList.add("hidden");
  document.getElementById("resultsPage").classList.remove("hidden");

  loadResults();
}

function loadResults() {
  const body = document.getElementById("resultsBody");
  const podium = document.getElementById("podium");
  body.innerHTML = "";
  podium.innerHTML = "";

  onValue(ref(db,"votes"), snap => {
    const data = snap.val() || {};
    const totals = {};

    Object.values(data).forEach(v => {
      const sum = v.quality + v.spelling + v.creativity + v.english;
      totals[v.className] = (totals[v.className] || 0) + sum;

      const d = new Date(v.time);
      const t = d.toLocaleString('ko-KR', {
        month:'numeric', day:'numeric', weekday:'short',
        hour:'2-digit', minute:'2-digit', hour12:false
      });

      body.innerHTML += `
        <tr>
          <td>${v.className}</td>
          <td>${v.quality}</td>
          <td>${v.spelling}</td>
          <td>${v.creativity}</td>
          <td>${v.english}</td>
          <td>${t}</td>
        </tr>`;
    });

    Object.entries(totals)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,3)
      .forEach((r,i)=>{
        podium.innerHTML += `<div style="margin:6px 0;">
          ${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]} <b>${r[0]}</b> â€” ${r[1]}ì 
        </div>`;
      });

  }, { onlyOnce:true });
}

onValue(ref(db,"votes"), snap => {
  document.getElementById("totalCounter").textContent =
    "ì´ íˆ¬í‘œ ìˆ˜: " + (snap.val() ? Object.keys(snap.val()).length : 0);
});
</script>

</body>
</html>
