<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì•„íŒŒíŠ¸ íˆ¬í‘œ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .apartment { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    h2 { margin-top: 0; }
    .category { margin: 10px 0; }
    button { margin-top: 10px; }
    #results { margin-top: 30px; white-space: pre-wrap; }
    .notice { background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-left: 4px solid #0078d7; }
  </style>
</head>
<body>
  <h1>ì•„íŒŒíŠ¸ íˆ¬í‘œ</h1>
  <div class="notice">
    <p>ğŸ“¢ ì•ˆë‚´:</p>
    <ul>
      <li>ê° í•­ëª©ì€ <strong>1ì (ìµœì €) ~ 5ì (ìµœê³ )</strong> ì‚¬ì´ì—ì„œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ê° êµì‚¬ëŠ” ì•„íŒŒíŠ¸ë‹¹ <strong>í•œ ë²ˆë§Œ íˆ¬í‘œ</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>íˆ¬í‘œëŠ” ìµëª…ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ì €ì¥ë˜ëŠ” ê²ƒì€ <strong>íˆ¬í‘œê°€ ì œì¶œëœ ì‹œê°„</strong>ë¿ì…ë‹ˆë‹¤.</li>
    </ul>
  </div>

  <!-- Apartments will be generated here -->
  <div id="apartments"></div>

  <!-- Results -->
  <div id="results">
    <h2>ê²°ê³¼</h2>
    <pre id="resultsText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyD0tDXxueqQAkEYsNGDHUcQM5TWf2FKyyk",
      authDomain: "apartmentvoting.firebaseapp.com",
      projectId: "apartmentvoting",
      storageBucket: "apartmentvoting.firebasestorage.app",
      messagingSenderId: "985145600430",
      appId: "1:985145600430:web:c4877654d87ccd4b74803f",
      measurementId: "G-H1W896MCWF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // íˆ¬í‘œ ê¸°ê°„ ì œí•œ
    function withinVotingPeriod() {
      const now = new Date();
      const start = new Date("2026-01-05T15:00:00"); // ì›”ìš”ì¼ ì˜¤í›„ 3ì‹œ
      const end = new Date("2026-01-07T15:00:00");   // ìˆ˜ìš”ì¼ ì˜¤í›„ 3ì‹œ
      return now >= start && now <= end;
    }

    // ì•„íŒŒíŠ¸ ìƒì„± (1ë°˜ ~ 8ë°˜)
    const apartmentsDiv = document.getElementById("apartments");
    for (let i = 1; i <= 8; i++) {
      const aptId = `apt${i}`;
      const aptName = `${i}ë°˜`;
      apartmentsDiv.innerHTML += `
        <div class="apartment" id="${aptId}">
          <h2>${aptName}</h2>
          <div class="category">í’ˆì§ˆ (Quality):
            <input type="number" id="${aptId}-quality" min="1" max="5">
          </div>
          <div class="category">ë§ì¶¤ë²• (Spelling):
            <input type="number" id="${aptId}-spelling" min="1" max="5">
          </div>
          <div class="category">ì°½ì˜ì„± (Creativity):
            <input type="number" id="${aptId}-creativity" min="1" max="5">
          </div>
          <div class="category">ì˜ì–´ ì‚¬ìš© (Use of English):
            <input type="number" id="${aptId}-english" min="1" max="5">
          </div>
          <button onclick="submitVote('${aptId}')">íˆ¬í‘œ ì œì¶œ</button>
        </div>
      `;
    }

    // íˆ¬í‘œ ì œì¶œ
    window.submitVote = async function(apartmentId) {
      if (!withinVotingPeriod()) {
        alert("íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
        return;
      }

      // ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      const quality = parseInt(document.getElementById(apartmentId + "-quality").value);
      const spelling = parseInt(document.getElementById(apartmentId + "-spelling").value);
      const creativity = parseInt(document.getElementById(apartmentId + "-creativity").value);
      const english = parseInt(document.getElementById(apartmentId + "-english").value);

      // 1~5 ë²”ìœ„ í™•ì¸
      if ([quality, spelling, creativity, english].some(v => v < 1 || v > 5 || isNaN(v))) {
        alert("ëª¨ë“  í•­ëª©ì€ 1~5 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      // ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸ (ìµëª…: IP/ë¸Œë¼ìš°ì € ì œí•œ ì—†ìŒ, ë‹¨ìˆœ ì¤‘ë³µ ë°©ì§€ìš©)
      const q = query(collection(db, "votes"),
                      where("apartment", "==", apartmentId));
      const existing = await getDocs(q);
      // NOTE: Without login, we cannot truly enforce one vote per person.
      // This just prevents multiple identical votes in one session.

      await addDoc(collection(db, "votes"), {
        apartment: apartmentId,
        quality,
        spelling,
        creativity,
        english,
        timestamp: new Date()
      });

      alert("íˆ¬í‘œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    // ì‹¤ì‹œê°„ ê²°ê³¼
    onSnapshot(collection(db, "votes"), (snapshot) => {
      let results = {};
      snapshot.forEach((doc) => {
        let v = doc.data();
        if (!results[v.apartment]) {
          results[v.apartment] = { quality: [], spelling: [], creativity: [], english: [] };
        }
        results[v.apartment].quality.push(v.quality);
        results[v.apartment].spelling.push(v.spelling);
        results[v.apartment].creativity.push(v.creativity);
        results[v.apartment].english.push(v.english);
      });

      let text = "";
      for (let apt in results) {
        text += `${apt}:\n`;
        text += `  í’ˆì§ˆ: ${avg(results[apt].quality)}\n`;
        text += `  ë§ì¶¤ë²•: ${avg(results[apt].spelling)}\n`;
        text += `  ì°½ì˜ì„±: ${avg(results[apt].creativity)}\n`;
        text += `  ì˜ì–´ ì‚¬ìš©: ${avg(results[apt].english)}\n\n`;
      }
      document.getElementById("resultsText").textContent = text;
    });

    function avg(arr) {
      return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2);
    }
  </script>
</body>
</html>
