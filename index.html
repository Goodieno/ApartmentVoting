<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì•„íŒŒíŠ¸ íˆ¬í‘œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 12px;
      background: linear-gradient(180deg, #f4f6f8, #eef1f5);
      text-align: center;
    }

    h1 {
      font-size: 1.7em;
      margin-bottom: 10px;
      letter-spacing: 0.04em;
    }
    h2 {
      font-size: 1.35em;
      margin-bottom: 8px;
      letter-spacing: 0.03em;
    }

    button {
      margin: 6px 4px;
      padding: 12px 16px;
      font-size: 16px;
      cursor:pointer;
      border-radius: 10px;
      border: none;
      background: #e0e0e0;
    }

    button:active {
      transform: scale(0.97);
    }

    .hidden { display:none; }

    .panel {
      background:#fff;
      border-radius:18px;
      padding:20px 16px;
      max-width:720px;
      margin:16px auto;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }

    #classLinks {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 14px;
    }

    #totalCounter {
      font-size:1.2em;
      font-weight:bold;
      text-align:center;
      margin-top:20px;
    }

    .score-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 8px auto 18px auto;
      max-width: 420px;
    }

    .score-buttons button {
      background:#eee;
      border:1px solid #ccc;
      font-size:18px;
      padding:12px 0;
    }

    .score-buttons button.selected {
      background:#0078d7;
      color:white;
      font-weight:bold;
    }

    input[type="password"] {
      width: 90%;
      max-width: 360px;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin: 12px auto 6px auto;
      display: block;
      box-sizing: border-box;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin:16px auto 0 auto;
      font-size: 0.9em;
    }

    th, td {
      border:1px solid #ccc;
      padding:6px;
      text-align:center;
    }

    th {
      background:#eee;
    }

    @media (min-width: 600px) {
      #classLinks {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  </style>
</head>
<body>

<h1>5í•™ë…„ ì•„íŒŒíŠ¸ íˆ¬í‘œ</h1>
<p style="color:#c62828; font-weight:bold; margin-top:6px;">* êµì‚¬ë‹¹ 1íšŒë§Œ íˆ¬í‘œí•´ ì£¼ì„¸ìš” *</p>

<!-- HOME -->
<div id="home" class="panel">
  <h2>ë°˜ ëª©ë¡</h2>
  <div id="classLinks"></div>
  <div id="countdown" style="font-weight:bold; margin-top:10px; font-size:1.1em;"></div>
  <div id="totalCounter">ì´ íˆ¬í‘œ ìˆ˜: 0</div>
  <div style="text-align:center; margin-top:20px;">
    <button onclick="openAdmin()">ê´€ë¦¬ì</button>
  </div>
</div>

<!-- VOTING -->
<div id="votePage" class="panel hidden">
  <h2 id="voteTitle"></h2>
  <p style="text-align:center;">ê° í•­ëª©ì„ 1ì (ìµœì €) ~ 5ì (ìµœê³ )ë¡œ í‰ê°€í•˜ì„¸ìš”.</p>

  <div>í’ˆì§ˆ: <div class="score-buttons" id="quality-buttons"></div></div>
  <div>ë§ì¶¤ë²•: <div class="score-buttons" id="spelling-buttons"></div></div>
  <div>ì°½ì˜ì„±: <div class="score-buttons" id="creativity-buttons"></div></div>
  <div>ì˜ì–´ ì‚¬ìš©: <div class="score-buttons" id="english-buttons"></div></div>

  <div style="text-align:center; margin-top:20px;">
    <button onclick="submitVote()">íˆ¬í‘œ ì œì¶œ</button>
    <button onclick="goHome()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPage" class="panel hidden" style="text-align:center;">
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
  <input type="password" id="adminPass" placeholder="password">
  <div style="margin-top:10px;">
    <button onclick="viewResults()">ê²°ê³¼ ë³´ê¸°</button>
    <button onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
    <button onclick="goHome()">ëŒì•„ê°€ê¸°</button>
  </div>

  <div id="results" class="hidden">
    <h3>ğŸ† ìµœì¢… ê²°ê³¼</h3>
    <div id="podium"></div>

    <h3 style="margin-top:20px;">ì „ì²´ íˆ¬í‘œ ë‚´ì—­</h3>
    <h3>íˆ¬í‘œ ê²°ê³¼</h3>
    <table>
      <thead>
        <tr>
          <th>ë°˜</th>
          <th>í’ˆì§ˆ</th>
          <th>ë§ì¶¤ë²•</th>
          <th>ì°½ì˜ì„±</th>
          <th>ì˜ì–´</th><th>ì‹œê°„</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0tDXxueqQAkEYsNGDHUcQM5TWf2FKyyk",
    authDomain: "apartmentvoting.firebaseapp.com",
    databaseURL: "https://apartmentvoting-default-rtdb.firebaseio.com",
    projectId: "apartmentvoting",
    storageBucket: "apartmentvoting.firebasestorage.app",
    messagingSenderId: "985145600430",
    appId: "1:985145600430:web:c4877654d87ccd4b74803f"
  };

  // ===== VOTING DEADLINE =====
  // 2026-01-07 15:30 (KST)
  const VOTING_END = new Date(2026, 0, 7, 15, 30, 0);

  function updateCountdown() {
    const now = new Date();
    const diff = VOTING_END - now;
    const el = document.getElementById("countdown");

    if (diff <= 0) {
      el.textContent = "â›” íˆ¬í‘œ ì¢…ë£Œ";
      el.style.color = "#c62828";
      return;
    }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    el.textContent = `â° íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;

    // PANIC MODE: last 10 minutes
    if (diff <= 10 * 60 * 1000) {
      el.style.color = "#d32f2f";
      el.style.fontSize = "1.3em";
      el.style.animation = "pulse 1s infinite";
    }
  }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    el.textContent = `â³ íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${hours}ì‹œê°„ ${minutes}ë¶„`;
  }

  setInterval(updateCountdown, 1000);
  updateCountdown();

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentClass = null;
  let scores = { quality:null, spelling:null, creativity:null, english:null };

  const classLinksDiv = document.getElementById("classLinks");
  for (let i=1;i<=8;i++){
    const btn=document.createElement("button");
    btn.textContent=`${i}ë°˜`;
    btn.onclick=()=>openVotePage(`${i}ë°˜`);
    classLinksDiv.appendChild(btn);
  }

  function createScoreButtons(id,key){
    const c=document.getElementById(id);
    for(let i=1;i<=5;i++){
      const b=document.createElement("button");
      b.textContent=i;
      b.onclick=()=>{
        scores[key]=i;
        [...c.children].forEach(x=>x.classList.remove("selected"));
        b.classList.add("selected");
      };
      c.appendChild(b);
    }
  }

  createScoreButtons("quality-buttons","quality");
  createScoreButtons("spelling-buttons","spelling");
  createScoreButtons("creativity-buttons","creativity");
  createScoreButtons("english-buttons","english");

  window.openVotePage=function(cls){
    currentClass=cls;
    scores={ quality:null, spelling:null, creativity:null, english:null };
    document.querySelectorAll('.score-buttons button').forEach(b=>b.classList.remove('selected'));
    document.getElementById("voteTitle").textContent=cls+" íˆ¬í‘œ";
    show("votePage");
  }

  window.submitVote=async function(){
    const now = new Date();
    if (now > VOTING_END) {
      alert("íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      goHome();
      return;
    }

    if(Object.values(scores).includes(null)){
      alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”"); return;
    }
    await push(ref(db,"votes"),{ className:currentClass, ...scores, time:Date.now() });
    alert("íˆ¬í‘œ ì™„ë£Œ");
    goHome();
  }(){
    if(Object.values(scores).includes(null)){
      alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”"); return;
    }
    await push(ref(db,"votes"),{ className:currentClass, ...scores, time:Date.now() });
    alert("íˆ¬í‘œ ì™„ë£Œ");
    goHome();
  }

  window.openAdmin=function(){ show("adminPage"); }

  window.viewResults=function(){
    if(document.getElementById("adminPass").value!=="delete"){
      alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return;
    }

    const body=document.getElementById("resultsBody");
    const podium=document.getElementById("podium");
    body.innerHTML="";
    podium.innerHTML="";

    onValue(ref(db,"votes"),(snap)=>{
      const d=snap.val()||{};
      const totals={};

      Object.values(d).forEach(v=>{
        const sum=v.quality+v.spelling+v.creativity+v.english;
        totals[v.className]=(totals[v.className]||0)+sum;

        const date = new Date(v.time);
        const formatted = date.toLocaleString('ko-KR', {
          month:'numeric', day:'numeric', weekday:'short',
          hour:'2-digit', minute:'2-digit', hour12:false
        });

        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${v.className}</td><td>${v.quality}</td><td>${v.spelling}</td><td>${v.creativity}</td><td>${v.english}</td><td>${formatted}</td>`;
        body.appendChild(tr);
      });

      const ranked = Object.entries(totals)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,3);

      const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
      ranked.forEach((r,i)=>{
        const div=document.createElement('div');
        div.style.fontSize='1.2em';
        div.style.margin='6px 0';
        div.innerHTML=`${medals[i]} ${i+1}ìœ„: <b>${r[0]}</b> â€” ${r[1]}ì `;
        podium.appendChild(div);
      });

    },{onlyOnce:true});

    document.getElementById("results").classList.remove("hidden");
  }(){
    if(document.getElementById("adminPass").value!=="delete"){
      alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return;
    }
    const body=document.getElementById("resultsBody");
    body.innerHTML="";
    onValue(ref(db,"votes"),(snap)=>{
      const d=snap.val()||{};
      Object.values(d).forEach(v=>{
        const tr=document.createElement("tr");
        const date = new Date(v.time);
        const formatted = date.toLocaleString('ko-KR', {
          month: 'numeric',
          day: 'numeric',
          weekday: 'short',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
        tr.innerHTML = `<td>${v.className}</td><td>${v.quality}</td><td>${v.spelling}</td><td>${v.creativity}</td><td>${v.english}</td><td>${formatted}</td>`;
        body.appendChild(tr);
      });
    },{onlyOnce:true});
    document.getElementById("results").classList.remove("hidden");
  }

  window.deleteAll=async function(){
    if(document.getElementById("adminPass").value!=="delete"){
      alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return;
    }
    if(confirm("ì •ë§ ëª¨ë“  íˆ¬í‘œë¥¼ ì‚­ì œí•©ë‹ˆê¹Œ?")){
      await remove(ref(db,"votes"));
      alert("ì‚­ì œ ì™„ë£Œ");
      document.getElementById("resultsBody").innerHTML="";
    }
  }

  window.goHome=function(){ show("home"); }

  function show(id){
    ["home","votePage","adminPage"].forEach(x=>document.getElementById(x).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  onValue(ref(db,"votes"),(snap)=>{
    const d=snap.val();
    document.getElementById("totalCounter").textContent="ì´ íˆ¬í‘œ ìˆ˜: "+(d?Object.keys(d).length:0);
  });
</script>
</body>
</html>
