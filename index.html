<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>아파트 투표</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .class-link { margin: 10px 0; }
    .hidden { display: none; }
    button { margin-top: 10px; }
    #home h2 { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>아파트 투표 (1반–8반)</h1>
  <p>각 반을 클릭하면 해당 반의 투표 페이지로 이동합니다.</p>

  <!-- Home Page -->
  <div id="home">
    <h2>반 목록</h2>
    <div id="classLinks"></div>
  </div>

  <!-- Voting Page -->
  <div id="votePage" class="hidden">
    <h2 id="voteTitle"></h2>
    <p>각 항목은 1점(최저) ~ 5점(최고) 사이에서만 선택할 수 있습니다.</p>
    <div>품질 (Quality): <input type="number" id="quality" min="1" max="5"></div>
    <div>맞춤법 (Spelling): <input type="number" id="spelling" min="1" max="5"></div>
    <div>창의성 (Creativity): <input type="number" id="creativity" min="1" max="5"></div>
    <div>영어 사용 (Use of English): <input type="number" id="english" min="1" max="5"></div>
    <button onclick="submitVote()">투표 제출</button>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyD0tDXxueqQAkEYsNGDHUcQM5TWf2FKyyk",
      authDomain: "apartmentvoting.firebaseapp.com",
      projectId: "apartmentvoting",
      storageBucket: "apartmentvoting.firebasestorage.app",
      messagingSenderId: "985145600430",
      appId: "1:985145600430:web:c4877654d87ccd4b74803f",
      measurementId: "G-H1W896MCWF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 현재 선택된 반
    let currentClass = null;

    // 반 링크 생성 (1반–8반)
    const classLinksDiv = document.getElementById("classLinks");
    for (let i = 1; i <= 8; i++) {
      const link = document.createElement("button");
      link.textContent = `${i}반`;
      link.className = "class-link";
      link.onclick = () => openVotePage(`${i}반`);
      classLinksDiv.appendChild(link);

      // 투표 수 표시
      const countSpan = document.createElement("span");
      countSpan.id = `count-${i}반`;
      countSpan.style.marginLeft = "10px";
      countSpan.textContent = "(투표 수: 0)";
      classLinksDiv.appendChild(countSpan);
      classLinksDiv.appendChild(document.createElement("br"));
    }

    // 투표 페이지 열기
    function openVotePage(className) {
      currentClass = className;
      document.getElementById("voteTitle").textContent = className + " 투표";
      document.getElementById("home").classList.add("hidden");
      document.getElementById("votePage").classList.remove("hidden");
    }

    // 투표 제출
    window.submitVote = async function() {
      const quality = parseInt(document.getElementById("quality").value);
      const spelling = parseInt(document.getElementById("spelling").value);
      const creativity = parseInt(document.getElementById("creativity").value);
      const english = parseInt(document.getElementById("english").value);

      // 1~5 범위 확인
      if ([quality, spelling, creativity, english].some(v => v < 1 || v > 5 || isNaN(v))) {
        alert("모든 항목은 1~5 사이의 숫자여야 합니다.");
        return;
      }

      await addDoc(collection(db, "votes"), {
        className: currentClass,
        quality,
        spelling,
        creativity,
        english,
        timestamp: new Date()
      });

      alert("투표가 제출되었습니다!");

      // 입력 초기화
      document.getElementById("quality").value = "";
      document.getElementById("spelling").value = "";
      document.getElementById("creativity").value = "";
      document.getElementById("english").value = "";

      // 홈으로 돌아가기
      document.getElementById("votePage").classList.add("hidden");
      document.getElementById("home").classList.remove("hidden");
    };

    // 투표 수 실시간 업데이트
    onSnapshot(collection(db, "votes"), (snapshot) => {
      let counts = {};
      snapshot.forEach((doc) => {
        let v = doc.data();
        counts[v.className] = (counts[v.className] || 0) + 1;
      });

      for (let i = 1; i <= 8; i++) {
        const className = `${i}반`;
        const count = counts[className] || 0;
        document.getElementById(`count-${className}`).textContent = `(투표 수: ${count})`;
      }
    });
  </script>
</body>
</html>
