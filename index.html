<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì•„íŒŒíŠ¸ íˆ¬í‘œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  background: linear-gradient(180deg, #f4f6f8, #eef1f5);
  text-align: center;
}

h1 { font-size: 1.7em; margin-bottom: 6px; }
h2 { font-size: 1.3em; }

.panel {
  background: #fff;
  border-radius: 18px;
  padding: 20px 16px;
  max-width: 720px;
  margin: 14px auto;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

button {
  padding: 12px 16px;
  border-radius: 10px;
  border: none;
  background: #e0e0e0;
  font-size: 16px;
  cursor: pointer;
}

.hidden { display: none; }

#classLinks {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 14px;
}

.score-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  max-width: 420px;
  margin: 8px auto 18px auto;
}

.score-buttons button.selected {
  background: #0078d7;
  color: white;
  font-weight: bold;
}

input[type=password] {
  width: 90%;
  max-width: 360px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 14px;
  font-size: 0.9em;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@media (min-width:600px) {
  #classLinks { grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>

<body>

<h1>5í•™ë…„ ì•„íŒŒíŠ¸ íˆ¬í‘œ</h1>
<p style="color:#c62828; font-weight:bold;">
* êµì‚¬ë‹¹ 1íšŒë§Œ íˆ¬í‘œí•´ ì£¼ì„¸ìš” *
</p>

<div id="countdown" style="font-weight:bold; font-size:1.15em; margin:10px 0;"></div>

<!-- HOME -->
<div id="home" class="panel">
  <h2>ë°˜ ëª©ë¡</h2>
  <div id="classLinks"></div>
  <div id="totalCounter" style="margin-top:14px; font-weight:bold;">ì´ íˆ¬í‘œ ìˆ˜: 0</div>
  <button style="margin-top:14px;" onclick="openAdmin()">ê´€ë¦¬ì</button>
</div>

<!-- VOTING -->
<div id="votePage" class="panel hidden">
  <h2 id="voteTitle"></h2>
  <p>ê° í•­ëª©ì„ 1ì  ~ 5ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”.</p>

  <div>í’ˆì§ˆ<div class="score-buttons" id="quality"></div></div>
  <div>ë§ì¶¤ë²•<div class="score-buttons" id="spelling"></div></div>
  <div>ì°½ì˜ì„±<div class="score-buttons" id="creativity"></div></div>
  <div>ì˜ì–´ ì‚¬ìš©<div class="score-buttons" id="english"></div></div>

  <button onclick="submitVote()">íˆ¬í‘œ ì œì¶œ</button>
  <button onclick="goHome()">ì·¨ì†Œ</button>
</div>

<!-- ADMIN -->
<div id="adminPage" class="panel hidden">
  <h2>ê´€ë¦¬ì</h2>
  <input type="password" id="adminPass" placeholder="password">
  <br><br>
  <button onclick="viewResults()">ê²°ê³¼ ë³´ê¸°</button>
  <button onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
  <button onclick="goHome()">ëŒì•„ê°€ê¸°</button>

  <div id="results" class="hidden">
    <h3>ğŸ† ê²°ê³¼</h3>
    <div id="podium"></div>

    <table>
      <thead>
        <tr>
          <th>ë°˜</th><th>í’ˆì§ˆ</th><th>ë§ì¶¤ë²•</th>
          <th>ì°½ì˜ì„±</th><th>ì˜ì–´</th><th>ì‹œê°„</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyD0tDXxueqQAkEYsNGDHUcQM5TWf2FKyyk",
  databaseURL: "https://apartmentvoting-default-rtdb.firebaseio.com"
});

const db = getDatabase(app);
const VOTING_END = new Date(2026,0,7,15,30);

let currentClass = null;
let scores = {};

function updateCountdown() {
  const diff = VOTING_END - new Date();
  const el = document.getElementById("countdown");

  if (diff <= 0) {
    el.textContent = "â›” íˆ¬í‘œ ì¢…ë£Œ";
    el.style.color = "#c62828";
    return;
  }

  const h = Math.floor(diff / 3600000);
  const m = Math.floor(diff % 3600000 / 60000);
  const s = Math.floor(diff % 60000 / 1000);

  el.textContent = `â° íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;

  if (diff <= 600000) {
    el.style.color = "#d32f2f";
    el.style.animation = "pulse 1s infinite";
  }
}

setInterval(updateCountdown, 1000);
updateCountdown();

const classLinks = document.getElementById("classLinks");
for (let i=1;i<=8;i++) {
  const b = document.createElement("button");
  b.textContent = `${i}ë°˜`;
  b.onclick = () => openVotePage(`${i}ë°˜`);
  classLinks.appendChild(b);
}

["quality","spelling","creativity","english"].forEach(k=>{
  const c=document.getElementById(k);
  for(let i=1;i<=5;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>{
      scores[k]=i;
      [...c.children].forEach(x=>x.classList.remove("selected"));
      b.classList.add("selected");
    };
    c.appendChild(b);
  }
});

window.openVotePage = cls => {
  if (localStorage.getItem("apartmentVoted")) {
    alert("ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.");
    return;
  }
  currentClass = cls;
  scores = {};
  document.getElementById("voteTitle").textContent = cls;
  show("votePage");
};

window.submitVote = async () => {
  if (new Date() > VOTING_END) return alert("íˆ¬í‘œ ì¢…ë£Œ");
  if (Object.keys(scores).length < 4) return alert("ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”");

  await push(ref(db,"votes"), { className: currentClass, ...scores, time: Date.now() });
  localStorage.setItem("apartmentVoted","true");
  alert("íˆ¬í‘œ ì™„ë£Œ");
  goHome();
};

window.openAdmin = () => show("adminPage");
window.goHome = () => show("home");

window.viewResults = () => {
  if (adminPass.value !== "delete") return alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  results.classList.remove("hidden");
  resultsBody.innerHTML = "";
  podium.innerHTML = "";

  onValue(ref(db,"votes"), snap => {
    const data = snap.val() || {};
    const totals = {};

    Object.values(data)
      .sort((a, b) => a.time - b.time)   // âœ… ONLY CHANGE
      .forEach(v=>{
        totals[v.className]=(totals[v.className]||0)+(v.quality+v.spelling+v.creativity+v.english);
        const d=new Date(v.time);
        const t=d.toLocaleString('ko-KR',{month:'numeric',day:'numeric',weekday:'short',hour:'2-digit',minute:'2-digit',hour12:false});
        resultsBody.innerHTML+=`<tr><td>${v.className}</td><td>${v.quality}</td><td>${v.spelling}</td><td>${v.creativity}</td><td>${v.english}</td><td>${t}</td></tr>`;
      });

    Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,3).forEach((r,i)=>{
      podium.innerHTML+=`<div>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]} ${r[0]} â€” ${r[1]}ì </div>`;
    });
  },{onlyOnce:true});
};

window.deleteAll = async () => {
  if (adminPass.value !== "delete") return alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  if (confirm("ëª¨ë‘ ì‚­ì œí•©ë‹ˆê¹Œ?")) await remove(ref(db,"votes"));
};

function show(id){
  ["home","votePage","adminPage"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

onValue(ref(db,"votes"), snap=>{
  totalCounter.textContent = "ì´ íˆ¬í‘œ ìˆ˜: " + (snap.val()?Object.keys(snap.val()).length:0);
});
</script>
</body>
</html>
